<?xml version="1.0"?>
<project name="common">

  <dirname property="root.dir" file="${ant.file.common}"/>
  <property file="${root.dir}/common/build.properties"/>

  <available file="${src}" type="dir" property="have.source"/>

  <pathconvert property="not.leaf" setonempty="false">
    <fileset dir="." includes="*/build.xml"/>
  </pathconvert>

  <target name="compile" if="have.source">
    <path id="compile.classpath" path="${build.cp}">
      <fileset dir="${root.dir}/lib" includes="osgi.*.jar"/>
      <fileset dir="${dist}" includes="*.jar"/>
    </path>
    <mkdir dir="${build}"/>
    <mkdir dir="${dist}"/>
    <property name="compile.level" value="1.3"/>
    <javac srcdir="${src}" destdir="${build}" debug="on"
           source="${compile.level}" target="${compile.level}">
      <classpath refid="compile.classpath"/>
    </javac>
    <copy todir="${build}" includeEmptyDirs="false">
      <fileset dir="${src}" excludes="**/*.java"/>
    </copy>
  </target>

  <taskdef resource="aQute/bnd/ant/taskdef.properties" classpath="${bnd.jar}"/>

  <target name="local.dist" if="have.source" unless="not.leaf">
    <antcall target="compile"/>
    <pathconvert pathsep="," dirsep="/" property="-classpath">
      <fileset dir="${root.dir}/lib" includes="osgi.*.jar"/>
    </pathconvert>
    <bnd files="build.properties" classpath="${build}"/>
  </target>

  <target name="local.pde" if="have.source" unless="not.leaf">
    <antcall target="local.dist"/>
    <copy file="${root.dir}/common/pde.project" tofile=".project">
      <filterset>
        <filter token="PROJECT" value="${Bundle-SymbolicName}-${version}"/>
      </filterset>
    </copy>
    <copy file="${root.dir}/common/pde.classpath" tofile=".classpath">
      <filterset>
        <filter token="SRC" value="${src}"/>
        <filter token="BUILD" value="${build}"/>
      </filterset>
    </copy>
    <unjar src="${-output}" dest="build">
      <patternset>
        <include name="META-INF/MANIFEST.MF"/>
      </patternset>
    </unjar>
    <mkdir dir="META-INF/embedded"/>
    <concat destfile="META-INF/MANIFEST.MF">
      <header file="${root.dir}/common/MANIFEST.MF"/>
      <path path="build/META-INF/MANIFEST.MF"/>
    </concat>
  </target>

  <target name="local.clean">
    <delete dir="felix-cache"/>
    <delete dir="${build}"/>
    <delete dir="dist"/>
  </target>

  <target name="local.wipe" depends="local.clean">
    <delete dir="${dist}"/>
    <delete file=".project"/>
    <delete file=".classpath"/>
    <delete dir="META-INF"/>
  </target>

  <macrodef name="iterate">
    <attribute name="target"/>
    <sequential>
      <subant target="@{target}">
        <fileset dir="." includes="*/build.xml"/>
      </subant>
    </sequential>
  </macrodef>

  <target name="dist" depends="local.dist" if="not.leaf">
    <iterate target="dist"/>
  </target>

  <target name="pde" depends="local.pde" if="not.leaf">
    <iterate target="pde"/>
  </target>

  <target name="clean" depends="local.clean" if="not.leaf">
    <delete dir="${dist}"/>
    <iterate target="clean"/>
  </target>

  <target name="wipe" depends="local.wipe" if="not.leaf">
    <iterate target="wipe"/>
  </target>

</project>
